<!doctype html>
<html lang="en">
<head>
    <!-- Required meta tags -->
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

    <!-- Bootstrap CSS -->
    <script src="https://code.jquery.com/jquery-3.4.1.js"></script>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.2.1/css/bootstrap.min.css"
          integrity="sha384-GJzZqFGwb1QTTN6wy59ffF1BuGJpLSa9DkKMp0DgiMDm4iYMj70gZWKYbI706tWS" crossorigin="anonymous">


    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.6/umd/popper.min.js"
            integrity="sha384-wHAiFfRlMFy6i5SRaxvfOCifBUQy1xHdJ/yoi7FRNXMRBu5WHdZYu1hA6ZOblgut"
            crossorigin="anonymous"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.2.1/js/bootstrap.min.js"
            integrity="sha384-B0UglyR+jN6CkvvICOB2joaf5I4l3gm9GU6Hc1og6Ls7i6U/mkkaduKaBhlAXv9k"
            crossorigin="anonymous"></script>

    <script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>
    <title>Cite Diversely</title>

    <style>
        #spinner { display:none; }
        body.busy .spinner { display:inline-block !important; }
    </style>
</head>
<body data-spy="scroll" data-target=".navpills" data-offset="100">

<div class="container-fluid">
    <div class="row">
<div class="col-3 px-0 bg-secondary position-fixed vh-100" style="min-width: 250px" id="sticky-sidebar">

    <div id="home" class="jumbotron jumbotron-fluid bg-dark">
        <div class="container text-white text-center ">
            <h1 class="display-5">Cite Diversely</h1>
            <p class="lead px-3">Estimate the diversity of the references you use</p>
        </div>
    </div>


    <div class="nav flex-column flex-nowrap overflow-auto p-2 my-5">
        <a href="#why" class="nav-link text-white">Why Is This important?</a>
        <a href="#thetool" class="nav-link text-white">Evaluate Your References</a>
        <a href="#theresults" class="nav-link text-white">View Your Results</a>
        <a href="#faq" class="nav-link text-white">Frequently Asked Questions</a>
        <a href="#contribute" class="nav-link text-white">Contribute</a>
    </div>

    <div class="col-3 font-small text-center text-light bg-dark fixed-bottom py-3" style="min-width: 250px" >
        © Copyright <script>document.write(new Date().getFullYear())</script> Chris McComb<br/>
        Powered by <a href="https://github.com"><img style="fill: blue" alt="GitHub" src="./assets/github.svg" height="15"/></a> and <a href="https://azure.microsoft.com/en-us/services/functions/"><img alt="Azure" src="./assets/azurefunctions.svg" height="20"/></a>
    </div>

</div>

<div class="col offset-3 p-0">

<div id="why" class="container px-5 mt-5 mb-5">
    <h2>Why Is This Important?</h2>
    <p>Simply put, many people often cite people that are like them. This is a problem because academia has historically been white male dominated, leading to the suppression of marginalized voices. If your citations are biased towards people who look like you, then you are missing out on high-quality work.</p>
    <p>Its important to note that using this site is not a replacement for truly being diligent and engaged in citing diverse voices. Rather, this site is just a place to start, and hopefully the first step in your journey of citing more diversely. To learn more about your duty to dismantle institutional oppression through your citation practices, read up here:</p>
    <ul>
        <li><a href="https://www.citeblackwomencollective.org">Cite Black Women</a></li>
        <li><a href="https://www.insidehighered.com/advice/2018/04/27/racial-exclusions-scholarly-citations-opinion">The Racial Politics of Citation</a></li>
        <li><a href="https://blog.mahabali.me/writing/inclusive-citation-how-diverse-are-your-references/">Inclusive Citation: How Diverse Are Your References?</a></li>
    </ul>
</div>

<div class="container px-5 mt-5 mb-5" id="thetool">
    <h2>Evaluate Your References</h2>
    <p>Copy and paste the contents of your bibtex file below and we will do our best to evaluate the gender and ethnicity of the people you cite (note that this is a best guess only).</p>
    <form>
        <div class="form-group">
            <label for="abstract"></label>
            <textarea class="form-control" id="abstract" rows="20"></textarea>
        </div>

        <button id="submit" class="btn btn-primary">
            <span id="spinner" class="spinner spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>
            Submit
        </button>
    </form>
</div>

<div class="container px-5 mt-5 mb-5" id="theresults">
    <h2>View The Results</h2>
    <div id="accordionresults">

        <div class="card">
            <div class="card-header">
                <a class="card-link" data-toggle="collapse" href="#collapseOneResults">
                    Overall Estimated Diversity
                </a>
            </div>
            <div id="collapseOneResults" class="collapse d-none">
                <div class="card-body">
                    <div class="row">
                        <div id="gender_piechart" class="col"></div>
                    </div>
                    <div class="row">
                        <div id="ethnicity_piechart" class="col"></div>
                    </div>
                </div>
            </div>
        </div>

        <div class="card">
            <div class="card-header">
                <a class="card-link" data-toggle="collapse" href="#collapseTwoResults">
                    Recommendations
                </a>
            </div>
            <div id="collapseTwoResults" class="collapse d-none">
                <div class="card-body">
                    <div class="row">
                        <div id="recommendations" class="col"></div>
                    </div>
                </div>
            </div>
        </div>

        <div class="card">
            <div class="card-header">
                <a class="card-link" data-toggle="collapse" href="#collapseThreeResults">
                    Detailed Results
                </a>
            </div>
            <div id="collapseThreeResults" class="collapse d-none">
                <div class="card-body">
                    <div class="row">
                        <div id="full_table" class="col"></div>
                    </div>
                </div>
            </div>
        </div>

    </div>

</div>

<div id="faq" class="container px-5 mt-5 mb-5">
    <h2>Frequently Asked Questions</h2>

    <div id="accordion">

        <div class="card">
            <div class="card-header">
                <a class="card-link" data-toggle="collapse" href="#collapseOne">
                    Can I still use this even if I don't use LaTeX?
                </a>
            </div>
            <div id="collapseOne" class="collapse show" data-parent="#accordion">
                <div class="card-body">
                    If you don't directly use LaTeX, you can still export a bibtex file. There are instructions on how to do so for <a href="https://blog.mendeley.com/2011/10/25/howto-use-mendeley-to-create-citations-using-latex-and-bibtex/">Mendeley</a>, <a href="https://libguides.usask.ca/c.php?g=218034&p=1458583">EndNote</a>, and <a href="https://libguides.usask.ca/c.php?g=218034&p=1446406">Zotero</a>.
                </div>
            </div>
        </div>

        <div class="card">
            <div class="card-header">
                <a class="collapsed card-link" data-toggle="collapse" href="#collapseTwo">
                    Why are so many of my references in the "unable to determine" category?
                </a>
            </div>
            <div id="collapseTwo" class="collapse" data-parent="#accordion">
                <div class="card-body">
                    Some common reasons why authors are placed in the "unable to determine" category include: uncommon last name (fewer than 100 instances in the 2010 US Census), and first names in your bibtex are initials only.
                </div>
            </div>
        </div>

        <div class="card">
            <div class="card-header">
                <a class="collapsed card-link" data-toggle="collapse" href="#collapseThree">
                    How does this actually work?
                </a>
            </div>
            <div id="collapseThree" class="collapse" data-parent="#accordion">
                <div class="card-body">
                    To infer gender we use the first names of the authors you cite and run them through <a href="https://pypi.org/project/gender-guesser/">this library</a>, which is admittedly Euro-centric. To infer ethnicity we do a lookup by last name using the <a href="https://www.census.gov/data/developers/data-sets/surnames.html">2010 US census data</a>. The backend calculations are all done with <a href="https://github.com/cite-diversely/backend">this GitHub repo</a>, and this site is hosted in <a href="https://github.com/cite-diversely/cite-diversely.github.io">this Github repo</a>.
                </div>
            </div>
        </div>
    </div>


</div>

<div id="contribute" class="container px-5 mt-5 mb-5">
    <h2>Contribute</h2>
    <p>Do you want to help out? <a href="mailto:mccomb@psu.edu">Send me an email</a> or contribute to the <a href="https://github.com/cite-diversely/backend">backend</a> or <a href="https://github.com/cite-diversely/cite-diversely.github.io">frontend</a> on GitHub.</p>

</div>

<!--<footer class="page-footer font-small text-center py-3 text-light bg-dark">-->
<!--    © 2020 Chris McComb, powered by GitHub and Azure.-->
<!--</footer>-->

</div>
    </div>
</div>

<script>
    // Bogus ajax call to warm up the server
    let url_to_call = ''
    if (location.hostname === "localhost") {
        url_to_call = 'http://localhost:7071/api/HttpTrigger2';
    } else {
        url_to_call = 'https://cite-diversely.azurewebsites.net/api/HttpTrigger2?code=5l5c0c5WFafrCPDnG8GhpYlzeMx8FGfkFO9ratBkzh9KpP31UDmgfQ==';
    }

    $.ajax({
        url: url_to_call,
        type: "POST",
        data: "Chris McComb"
    });


    let full_results = [];

    // Set the default text
    var textAreas = document.getElementsByTagName('textarea');

    textAreas[0].value = "@article{Raina2019,\n" +
        "    author = {Raina, Ayush and McComb, Christopher and Cagan, Jonathan},\n" +
        "    title = {Learning to Design From Humans: Imitating Human Designers Through Deep Learning},\n" +
        "    journal = {Journal of Mechanical Design},\n" +
        "    volume = {141},\n" +
        "    number = {11},\n" +
        "    year = {2019},\n" +
        "    month = {09},\n" +
        "    issn = {1050-0472},\n" +
        "    doi = {10.1115/1.4044256}\n" +
        "}\n" +
        "\n" +
        "@article{Williams2019,\n" +
        "    author = {Williams, Glen and Meisel, Nicholas A. and Simpson, Timothy W. and McComb, Christopher},\n" +
        "    title = {Design Repository Effectiveness for 3D Convolutional Neural Networks: Application to Additive Manufacturing},\n" +
        "    journal = {Journal of Mechanical Design},\n" +
        "    volume = {141},\n" +
        "    number = {11},\n" +
        "    year = {2019},\n" +
        "    month = {09},\n" +
        "    issn = {1050-0472},\n" +
        "    doi = {10.1115/1.4044199}\n" +
        "}\n"

    google.charts.load('current', {'packages':['corechart']});

    function drawCharts(full_results) {
        let results = {male: 0, andy: 0, female: 0, gender_unknown: 0, white: 0, black: 0, api: 0, aian: 0, multi:0 , hispanic: 0, race_unknown: 0}
        for (let idx = 0; idx < full_results.length; idx++) {
            if (full_results[idx].gender === 'male' || full_results[idx].gender === 'mostly_male') {
                results.male += 1;
            }

            if (full_results[idx].gender === 'female' || full_results[idx].gender === 'mostly_female') {
                results.female += 1;
            }

            if (full_results[idx].gender === 'andy') {
                results.andy += 1;
            }

            if (full_results[idx].gender === 'unknown') {
                results.gender_unknown += 1;
            }

            if (full_results[idx].ethnicity === 'pctwhite') {
                results.white += 1;
            }

            if (full_results[idx].ethnicity === 'pctblack') {
                results.black += 1;
            }

            if (full_results[idx].ethnicity === 'pctapi') {
                results.api += 1;
            }

            if (full_results[idx].ethnicity === 'pctaian') {
                results.aian += 1;
            }

            if (full_results[idx].ethnicity === 'pct2prace') {
                results.multi += 1;
            }

            if (full_results[idx].ethnicity === 'pcthispanic') {
                results.hispanic += 1;
            }

            if (full_results[idx].ethnicity === 'race_unknown') {
                results.race_unknown += 1;
            }
        }

        var gender_data = google.visualization.arrayToDataTable([
            ['Gender', 'Count'],
            ['Likely Male', results.male],
            ['Hard to Tell', results.andy],
            ['Likely Female', results.female],
            ['Unable to Determine', results.gender_unknown]
        ]);

        var gender_options = {
            title: 'Gender Composition of References',
            pieHole: 0.4
        };

        var gender_chart = new google.visualization.PieChart(document.getElementById('gender_piechart'));
        gender_chart.draw(gender_data, gender_options);

        var ethnicity_data = google.visualization.arrayToDataTable([
            ['Ethnicity', 'Count'],
            ['Likely White', results.white],
            ['Likely Black', results.black],
            ['Likely Asian or Pacific Islander', results.api],
            ['Likely American Indian or Alaskan Native', results.aian],
            ['Likely Multiple Races', results.multi],
            ['Likely Hispanic', results.hispanic],
            ['Unable to Determine', results.race_unknown]
        ]);

        var ethnicity_options = {
            title: 'Race/Ethnicity Composition of References',
            pieHole: 0.4
        };

        var ethnicity_chart = new google.visualization.PieChart(document.getElementById('ethnicity_piechart'));
        ethnicity_chart.draw(ethnicity_data, ethnicity_options);
    }

    function drawTable(full_results) {
        let results = []
        // Clear table
        $("#full_table").empty()

        // Add header row
        let table = '<table class="table">' +
            '<thead>' +
                '<tr>' +
                    '<th scope="col">#</th>' +
                    '<th scope="col">First Name</th>' +
                    '<th scope="col">Last Name</th>' +
                    '<th scope="col">Estimated Ethnicity</th>' +
                    '<th scope="col">Estimated Gender</th>' +
                '</tr>' +
            '</thead>' +
            '<tbody>';

        // Clean up race and gender
        for (let idx = 0; idx < full_results.length; idx++) {
            results[idx] = {};
            results[idx].first = full_results[idx].first
            results[idx].last = full_results[idx].last
            if (full_results[idx].gender === 'male' || full_results[idx].gender === 'mostly_male') {
                results[idx].gender = 'Likely Male';
            } else if (full_results[idx].gender === 'female' || full_results[idx].gender === 'mostly_female') {
                results[idx].gender = 'Likely Female';
            } else if (full_results[idx].gender === 'unknown') {
                results[idx].gender = 'Unable to Determine';
            } else if (full_results[idx].gender === 'andy') {
                results[idx].gender = 'Hard to Tell';
            }
        }
        for (let idx = 0; idx < full_results.length; idx++) {
            if (full_results[idx].ethnicity === 'pctwhite') {
                results[idx].ethnicity = 'Likely White';
            } else if (full_results[idx].ethnicity === 'pctblack') {
                results[idx].ethnicity = 'Likely Black';
            } else if (full_results[idx].ethnicity === 'pctapi') {
                results[idx].ethnicity = 'Likely Asian or Pacific Islander';
            } else if (full_results[idx].ethnicity === 'pctaian') {
                results[idx].ethnicity = 'Likely American Indian or Alaskan Native';
            } else if (full_results[idx].ethnicity === 'pct2prace') {
                results[idx].ethnicity = 'Likely Multiple Races';
            } else if (full_results[idx].ethnicity === 'pcthispanic') {
                results[idx].ethnicity = 'Likely Hispanic';
            } else if (full_results[idx].ethnicity === 'race_unknown') {
                results[idx].ethnicity = 'Unable to Determine';
            }
        }

        // Make table contents
        for (let idx = 0; idx < results.length; idx++) {
            let race_cell_class = 'default';
            let gender_cell_class = 'default';
            if (results[idx].gender === 'Unable to Determine') {
                gender_cell_class ='table-warning';
            }

            if (results[idx].ethnicity === 'Unable to Determine' ) {
                race_cell_class ='table-warning';
            }

            if (results[idx].gender === 'Unable to Determine' && results[idx].ethnicity === 'Unable to Determine' ) {
                race_cell_class ='table-danger';
                gender_cell_class ='table-danger';
            }

                table = table + '<tr class="default">' +
                '<th scope="row">' + (idx+1) + '</th>' +
                '<td>' + results[idx].first + '</td>' +
                '<td>' + results[idx].last + '</td>' +
                '<td class="' + race_cell_class + '">' + results[idx].ethnicity + '</td>' +
                '<td class="' + gender_cell_class + '">' + results[idx].gender + '</td>' +
                '</tr>'
        }

        // Close table

        table = table + '</tbody></table>';

        $("#full_table").append(table);
    }

    function makeRecommendations(results) {

        // Clear recommendations
        $("#recommendations").empty()

        let recs = "<p>Here are a few papers (likely by minority authors) that you might want to consider:</p><ul>"

        for (let idx=0; idx < Math.min(results.recs.length, 5); idx++) {
            recs = recs + "<li><a href='" + results.recs[idx].id + "'>" + results.recs[idx].title + "</a></li>";
        }

        recs = recs + "</ul>"

        $("#recommendations").append(recs);
    }

    function get_data(event) {
        full_results = []
        $('body').addClass('busy');
        $('#submit').prop('disabled', true);

        event.preventDefault();

        // Get the details
        let abstract = $("#abstract").val();

        let url_to_call = '';
        if (location.hostname === "localhost") {
            url_to_call = 'http://localhost:7071/api/HttpTrigger2';
        } else {
            url_to_call = 'https://cite-diversely.azurewebsites.net/api/HttpTrigger2?code=5l5c0c5WFafrCPDnG8GhpYlzeMx8FGfkFO9ratBkzh9KpP31UDmgfQ==';
        }


        $(".d-none").removeClass("d-none").removeClass("disabled");
        $("#collapseOneResults").collapse('show');
        $("#gender_piechart").height(400);
        $("#ethnicity_piechart").height(400);

        $('html, body').animate({
            scrollTop: $('#theresults').offset().top
        }, 500);

        // Extract authors
        let authors = abstract.match(/author\s*=\s*{.*}/gi)


        for (let idx = 0;  idx < authors.length; idx++ ) {
            let author_list = authors[idx].split(" and ");

            for (let jdx = 0; jdx < author_list.length; jdx++) {

                let this_author = author_list[jdx].replaceAll("}", "").replace(/author\s*=\s*{/i, "").replaceAll("{", "")

                $.ajax({
                    url: url_to_call,
                    type: "POST",
                    data: this_author,
                    success: function (results) {
                        $('#submit').prop('disabled', false);
                        $('body').removeClass('busy');

                        console.log(results)

                        full_results.push(results)

                        drawCharts(full_results);
                        drawTable(full_results);
                    },
                    error: function (results) {
                        $('#submit').prop('disabled', false);
                        $('body').removeClass('busy');

                        $("#thetool").prepend("<div class=\"alert alert-danger alert-dismissible fixed-top\">\n" +
                            "    <a href=\"#\" class=\"close\" data-dismiss=\"alert\" aria-label=\"close\">&times;</a>\n" +
                            "    <strong>Oops!</strong> Something went wrong.\n<code>" + JSON.stringify(results) + "</code>" +
                            "  </div>");

                        window.setTimeout(function () {
                            $(".alert").fadeTo(500, 0).slideUp(500, function () {
                                $(this).remove();
                            });
                        }, 10000);
                    }
                });
            }
        }


    }

    $("#submit").on('click', get_data)

</script>

</body>
</html>
